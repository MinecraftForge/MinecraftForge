--- a/net/minecraft/world/inventory/AnvilMenu.java
+++ b/net/minecraft/world/inventory/AnvilMenu.java
@@ -31,6 +_,10 @@
    private static final int f_150466_ = 1;
    private static final int f_150467_ = 1;
 
+   @javax.annotation.Nullable
+   private net.minecraftforge.common.crafting.IBlacksmithingRecipe selectedRecipe;
+   private final net.minecraft.world.level.Level level;
+
    public AnvilMenu(int p_39005_, Inventory p_39006_) {
       this(p_39005_, p_39006_, ContainerLevelAccess.f_39287_);
    }
@@ -38,6 +_,7 @@
    public AnvilMenu(int p_39008_, Inventory p_39009_, ContainerLevelAccess p_39010_) {
       super(MenuType.f_39964_, p_39008_, p_39009_, p_39010_);
       this.m_38895_(this.f_39002_);
+      this.level = p_39009_.f_35978_.f_19853_;
    }
 
    protected boolean m_8039_(BlockState p_39019_) {
@@ -45,6 +_,7 @@
    }
 
    protected boolean m_6560_(Player p_39023_, boolean p_39024_) {
+      if (this.selectedRecipe != null) return this.selectedRecipe.canCraft(this.level, p_39023_, new net.minecraftforge.common.crafting.IBlacksmithingRecipe.AnvilContainerWrapper(f_39769_, f_39001_));
       return (p_39023_.m_150110_().f_35937_ || p_39023_.f_36078_ >= this.f_39002_.m_6501_()) && this.f_39002_.m_6501_() > 0;
    }
 
@@ -53,11 +_,26 @@
          p_150474_.m_6749_(-this.f_39002_.m_6501_());
       }
 
-      this.f_39769_.m_6836_(0, ItemStack.f_41583_);
-      if (this.f_39000_ > 0) {
+      var wrapper = new net.minecraftforge.common.crafting.IBlacksmithingRecipe.AnvilContainerWrapper(f_39769_, f_39001_);
+      float breakChance = this.selectedRecipe == null ? net.minecraftforge.common.ForgeHooks.onAnvilRepair(p_150474_, p_150475_, AnvilMenu.this.f_39769_.m_8020_(0), AnvilMenu.this.f_39769_.m_8020_(1)) : this.selectedRecipe.getBreakChance(p_150474_, wrapper, p_150475_);
+      this.f_39768_.m_8015_(p_150474_);
+      int base = this.selectedRecipe == null ? 0 : this.selectedRecipe.getBaseItemCost(this.level, wrapper);
+      if (base > 0) {
+         ItemStack itemstack = this.f_39769_.m_8020_(0);
+         if (!itemstack.m_41619_() && itemstack.m_41613_() > base) {
+            itemstack.m_41774_(base);
+            this.f_39769_.m_6836_(0, itemstack);
+         } else {
+            this.f_39769_.m_6836_(0, ItemStack.f_41583_);
+         }
+      } else {
+         this.f_39769_.m_6836_(0, ItemStack.f_41583_);
+      }
+      int additional = this.selectedRecipe == null ? this.f_39000_ : this.selectedRecipe.getAdditionalItemCost(this.level, wrapper);
+      if (additional > 0) {
          ItemStack itemstack = this.f_39769_.m_8020_(1);
-         if (!itemstack.m_41619_() && itemstack.m_41613_() > this.f_39000_) {
-            itemstack.m_41774_(this.f_39000_);
+         if (!itemstack.m_41619_() && itemstack.m_41613_() > additional) {
+            itemstack.m_41774_(additional);
             this.f_39769_.m_6836_(1, itemstack);
          } else {
             this.f_39769_.m_6836_(1, ItemStack.f_41583_);
@@ -69,7 +_,7 @@
       this.f_39002_.m_6422_(0);
       this.f_39770_.m_39292_((p_150479_, p_150480_) -> {
          BlockState blockstate = p_150479_.m_8055_(p_150480_);
-         if (!p_150474_.m_150110_().f_35937_ && blockstate.m_60620_(BlockTags.f_13033_) && p_150474_.m_21187_().nextFloat() < 0.12F) {
+         if (!p_150474_.m_150110_().f_35937_ && blockstate.m_60620_(BlockTags.f_13033_) && p_150474_.m_21187_().nextFloat() < breakChance) {
             BlockState blockstate1 = AnvilBlock.m_48824_(blockstate);
             if (blockstate1 == null) {
                p_150479_.m_7471_(p_150480_, false);
@@ -86,6 +_,18 @@
    }
 
    public void m_6640_() {
+      var wrapper = new net.minecraftforge.common.crafting.IBlacksmithingRecipe.AnvilContainerWrapper(f_39769_, f_39001_);
+      var recipes = this.level.m_7465_().m_44056_(net.minecraftforge.common.ForgeMod.BLACKSMITHING, wrapper, this.level);
+      if (!recipes.isEmpty()) {
+         this.selectedRecipe = recipes.get(0);
+         ItemStack itemstack = this.selectedRecipe.m_5874_(wrapper);
+         this.f_39768_.m_6029_(this.selectedRecipe);
+         this.f_39768_.m_6836_(0, itemstack);
+         this.f_39002_.m_6422_(this.selectedRecipe.getXpCost(wrapper));
+         return;
+      }
+      this.selectedRecipe = null;
+      this.f_39768_.m_6029_(null);
       ItemStack itemstack = this.f_39769_.m_8020_(0);
       this.f_39002_.m_6422_(1);
       int i = 0;
@@ -100,8 +_,11 @@
          Map<Enchantment, Integer> map = EnchantmentHelper.m_44831_(itemstack1);
          j = j + itemstack.m_41610_() + (itemstack2.m_41619_() ? 0 : itemstack2.m_41610_());
          this.f_39000_ = 0;
+         boolean flag = false;
+
          if (!itemstack2.m_41619_()) {
-            boolean flag = itemstack2.m_150930_(Items.f_42690_) && !EnchantedBookItem.m_41163_(itemstack2).isEmpty();
+            if (!net.minecraftforge.common.ForgeHooks.onAnvilChange(this, itemstack, itemstack2, f_39768_, f_39001_, j, this.f_39771_)) return;
+            flag = itemstack2.m_41720_() == Items.f_42690_ && !EnchantedBookItem.m_41163_(itemstack2).isEmpty();
             if (itemstack1.m_41763_() && itemstack1.m_41720_().m_6832_(itemstack, itemstack2)) {
                int l2 = Math.min(itemstack1.m_41773_(), itemstack1.m_41776_() / 4);
                if (l2 <= 0) {
@@ -218,6 +_,7 @@
             i += k;
             itemstack1.m_41714_(new TextComponent(this.f_39001_));
          }
+         if (flag && !itemstack1.isBookEnchantable(itemstack2)) itemstack1 = ItemStack.f_41583_;
 
          this.f_39002_.m_6422_(j + i);
          if (i <= 0) {
@@ -271,5 +_,9 @@
 
    public int m_39028_() {
       return this.f_39002_.m_6501_();
+   }
+
+   public void setMaximumCost(int value) {
+      this.f_39002_.m_6422_(value);
    }
 }
