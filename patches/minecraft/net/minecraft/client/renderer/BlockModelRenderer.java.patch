--- ../src-base/minecraft/net/minecraft/client/renderer/BlockModelRenderer.java
+++ ../src-work/minecraft/net/minecraft/client/renderer/BlockModelRenderer.java
@@ -40,7 +40,7 @@
 
     public boolean func_187493_a(IBlockAccess p_187493_1_, IBakedModel p_187493_2_, IBlockState p_187493_3_, BlockPos p_187493_4_, BufferBuilder p_187493_5_, boolean p_187493_6_, long p_187493_7_)
     {
-        boolean flag = Minecraft.func_71379_u() && p_187493_3_.func_185906_d() == 0 && p_187493_2_.func_177555_b();
+        boolean flag = Minecraft.func_71379_u() && p_187493_3_.getLightValue(p_187493_1_, p_187493_4_) == 0 && p_187493_2_.isAmbientOcclusion(p_187493_3_);
 
         try
         {
@@ -65,7 +65,7 @@
 
         for (EnumFacing enumfacing : EnumFacing.values())
         {
-            List<BakedQuad> list = p_187498_2_.func_188616_a(p_187498_3_, enumfacing, p_187498_7_);
+            List<BakedQuad> list = p_187498_2_.getQuads(p_187498_3_, enumfacing, p_187498_7_, p_187498_5_.getRenderLayer());
 
             if (!list.isEmpty() && (!p_187498_6_ || p_187498_3_.func_185894_c(p_187498_1_, p_187498_4_, enumfacing)))
             {
@@ -74,7 +74,7 @@
             }
         }
 
-        List<BakedQuad> list1 = p_187498_2_.func_188616_a(p_187498_3_, (EnumFacing)null, p_187498_7_);
+        List<BakedQuad> list1 = p_187498_2_.getQuads(p_187498_3_, (EnumFacing)null, p_187498_7_, p_187498_5_.getRenderLayer());
 
         if (!list1.isEmpty())
         {
@@ -92,17 +92,17 @@
 
         for (EnumFacing enumfacing : EnumFacing.values())
         {
-            List<BakedQuad> list = p_187497_2_.func_188616_a(p_187497_3_, enumfacing, p_187497_7_);
+            List<BakedQuad> list = p_187497_2_.getQuads(p_187497_3_, enumfacing, p_187497_7_, p_187497_5_.getRenderLayer());
 
             if (!list.isEmpty() && (!p_187497_6_ || p_187497_3_.func_185894_c(p_187497_1_, p_187497_4_, enumfacing)))
             {
-                int i = p_187497_3_.func_185889_a(p_187497_1_, p_187497_4_.func_177972_a(enumfacing));
+                int i = p_187497_3_.func_177230_c().getPackedLightmapCoords(p_187497_3_, p_187497_1_, p_187497_4_.func_177972_a(enumfacing), p_187497_5_.getRenderLayer());
                 this.func_187496_a(p_187497_1_, p_187497_3_, p_187497_4_, i, false, p_187497_5_, list, bitset);
                 flag = true;
             }
         }
 
-        List<BakedQuad> list1 = p_187497_2_.func_188616_a(p_187497_3_, (EnumFacing)null, p_187497_7_);
+        List<BakedQuad> list1 = p_187497_2_.getQuads(p_187497_3_, (EnumFacing)null, p_187497_7_, p_187497_5_.getRenderLayer());
 
         if (!list1.isEmpty())
         {
@@ -125,10 +125,17 @@
         {
             BakedQuad bakedquad = p_187492_5_.get(i);
             this.func_187494_a(p_187492_2_, bakedquad.func_178209_a(), bakedquad.func_178210_d(), p_187492_6_, p_187492_7_);
-            p_187492_8_.func_187491_a(p_187492_1_, p_187492_2_, p_187492_3_, bakedquad.func_178210_d(), p_187492_6_, p_187492_7_);
+            p_187492_8_.updateVertexBrightness(p_187492_1_, p_187492_2_, p_187492_3_, bakedquad.func_178210_d(), p_187492_6_, p_187492_7_, p_187492_4_.getRenderLayer());
             p_187492_4_.func_178981_a(bakedquad.func_178209_a());
             p_187492_4_.func_178962_a(p_187492_8_.field_178207_c[0], p_187492_8_.field_178207_c[1], p_187492_8_.field_178207_c[2], p_187492_8_.field_178207_c[3]);
-
+            if(bakedquad.shouldApplyDiffuseLighting())
+            {
+                float diffuse = net.minecraftforge.client.model.pipeline.LightUtil.diffuseLight(bakedquad.func_178210_d());
+                p_187492_8_.field_178206_b[0] *= diffuse;
+                p_187492_8_.field_178206_b[1] *= diffuse;
+                p_187492_8_.field_178206_b[2] *= diffuse;
+                p_187492_8_.field_178206_b[3] *= diffuse;
+            }
             if (bakedquad.func_178212_b())
             {
                 int k = this.field_187499_a.func_186724_a(p_187492_2_, p_187492_1_, p_187492_3_, bakedquad.func_178211_c());
@@ -244,7 +251,7 @@
             {
                 this.func_187494_a(p_187496_2_, bakedquad.func_178209_a(), bakedquad.func_178210_d(), (float[])null, p_187496_8_);
                 BlockPos blockpos = p_187496_8_.get(0) ? p_187496_3_.func_177972_a(bakedquad.func_178210_d()) : p_187496_3_;
-                p_187496_4_ = p_187496_2_.func_185889_a(p_187496_1_, blockpos);
+                p_187496_4_ = p_187496_2_.func_177230_c().getPackedLightmapCoords(p_187496_2_, p_187496_1_, blockpos, p_187496_6_.getRenderLayer());
             }
 
             p_187496_6_.func_178981_a(bakedquad.func_178209_a());
@@ -262,11 +269,26 @@
                 float f = (float)(k >> 16 & 255) / 255.0F;
                 float f1 = (float)(k >> 8 & 255) / 255.0F;
                 float f2 = (float)(k & 255) / 255.0F;
+                if(bakedquad.shouldApplyDiffuseLighting())
+                {
+                    float diffuse = net.minecraftforge.client.model.pipeline.LightUtil.diffuseLight(bakedquad.func_178210_d());
+                    f *= diffuse;
+                    f1 *= diffuse;
+                    f2 *= diffuse;
+                }
                 p_187496_6_.func_178978_a(f, f1, f2, 4);
                 p_187496_6_.func_178978_a(f, f1, f2, 3);
                 p_187496_6_.func_178978_a(f, f1, f2, 2);
                 p_187496_6_.func_178978_a(f, f1, f2, 1);
             }
+            else if(bakedquad.shouldApplyDiffuseLighting())
+            {
+                float diffuse = net.minecraftforge.client.model.pipeline.LightUtil.diffuseLight(bakedquad.func_178210_d());
+                p_187496_6_.func_178978_a(diffuse, diffuse, diffuse, 4);
+                p_187496_6_.func_178978_a(diffuse, diffuse, diffuse, 3);
+                p_187496_6_.func_178978_a(diffuse, diffuse, diffuse, 2);
+                p_187496_6_.func_178978_a(diffuse, diffuse, diffuse, 1);
+            }
 
             p_187496_6_.func_178987_a(d0, d1, d2);
         }
@@ -345,6 +367,11 @@
 
         public void func_187491_a(IBlockAccess p_187491_1_, IBlockState p_187491_2_, BlockPos p_187491_3_, EnumFacing p_187491_4_, float[] p_187491_5_, BitSet p_187491_6_)
         {
+            updateVertexBrightness(p_187491_1_, p_187491_2_, p_187491_3_, p_187491_4_, p_187491_5_, p_187491_6_, null);
+        }
+
+        public void updateVertexBrightness(IBlockAccess p_187491_1_, IBlockState p_187491_2_, BlockPos p_187491_3_, EnumFacing p_187491_4_, float[] p_187491_5_, BitSet p_187491_6_, @Nullable net.minecraft.util.BlockRenderLayer layer)
+        {
             BlockPos blockpos = p_187491_6_.get(0) ? p_187491_3_.func_177972_a(p_187491_4_) : p_187491_3_;
             BlockPos.PooledMutableBlockPos blockpos$pooledmutableblockpos = BlockPos.PooledMutableBlockPos.func_185346_s();
             BlockModelRenderer.EnumNeighborInfo blockmodelrenderer$enumneighborinfo = BlockModelRenderer.EnumNeighborInfo.func_178273_a(p_187491_4_);
@@ -352,10 +379,10 @@
             BlockPos.PooledMutableBlockPos blockpos$pooledmutableblockpos2 = BlockPos.PooledMutableBlockPos.func_185342_g(blockpos).func_189536_c(blockmodelrenderer$enumneighborinfo.field_178276_g[1]);
             BlockPos.PooledMutableBlockPos blockpos$pooledmutableblockpos3 = BlockPos.PooledMutableBlockPos.func_185342_g(blockpos).func_189536_c(blockmodelrenderer$enumneighborinfo.field_178276_g[2]);
             BlockPos.PooledMutableBlockPos blockpos$pooledmutableblockpos4 = BlockPos.PooledMutableBlockPos.func_185342_g(blockpos).func_189536_c(blockmodelrenderer$enumneighborinfo.field_178276_g[3]);
-            int i = p_187491_2_.func_185889_a(p_187491_1_, blockpos$pooledmutableblockpos1);
-            int j = p_187491_2_.func_185889_a(p_187491_1_, blockpos$pooledmutableblockpos2);
-            int k = p_187491_2_.func_185889_a(p_187491_1_, blockpos$pooledmutableblockpos3);
-            int l = p_187491_2_.func_185889_a(p_187491_1_, blockpos$pooledmutableblockpos4);
+            int i = p_187491_2_.func_177230_c().getPackedLightmapCoords(p_187491_2_, p_187491_1_, blockpos$pooledmutableblockpos1, layer);
+            int j = p_187491_2_.func_177230_c().getPackedLightmapCoords(p_187491_2_, p_187491_1_, blockpos$pooledmutableblockpos2, layer);
+            int k = p_187491_2_.func_177230_c().getPackedLightmapCoords(p_187491_2_, p_187491_1_, blockpos$pooledmutableblockpos3, layer);
+            int l = p_187491_2_.func_177230_c().getPackedLightmapCoords(p_187491_2_, p_187491_1_, blockpos$pooledmutableblockpos4, layer);
             float f = p_187491_1_.func_180495_p(blockpos$pooledmutableblockpos1).func_185892_j();
             float f1 = p_187491_1_.func_180495_p(blockpos$pooledmutableblockpos2).func_185892_j();
             float f2 = p_187491_1_.func_180495_p(blockpos$pooledmutableblockpos3).func_185892_j();
@@ -376,7 +403,7 @@
             {
                 BlockPos blockpos1 = blockpos$pooledmutableblockpos.func_189533_g(blockpos$pooledmutableblockpos1).func_189536_c(blockmodelrenderer$enumneighborinfo.field_178276_g[2]);
                 f4 = p_187491_1_.func_180495_p(blockpos1).func_185892_j();
-                i1 = p_187491_2_.func_185889_a(p_187491_1_, blockpos1);
+                i1 = p_187491_2_.func_177230_c().getPackedLightmapCoords(p_187491_2_, p_187491_1_, blockpos1, layer);
             }
 
             float f5;
@@ -391,7 +418,7 @@
             {
                 BlockPos blockpos2 = blockpos$pooledmutableblockpos.func_189533_g(blockpos$pooledmutableblockpos1).func_189536_c(blockmodelrenderer$enumneighborinfo.field_178276_g[3]);
                 f5 = p_187491_1_.func_180495_p(blockpos2).func_185892_j();
-                j1 = p_187491_2_.func_185889_a(p_187491_1_, blockpos2);
+                j1 = p_187491_2_.func_177230_c().getPackedLightmapCoords(p_187491_2_, p_187491_1_, blockpos2, layer);
             }
 
             float f6;
@@ -406,7 +433,7 @@
             {
                 BlockPos blockpos3 = blockpos$pooledmutableblockpos.func_189533_g(blockpos$pooledmutableblockpos2).func_189536_c(blockmodelrenderer$enumneighborinfo.field_178276_g[2]);
                 f6 = p_187491_1_.func_180495_p(blockpos3).func_185892_j();
-                k1 = p_187491_2_.func_185889_a(p_187491_1_, blockpos3);
+                k1 = p_187491_2_.func_177230_c().getPackedLightmapCoords(p_187491_2_, p_187491_1_, blockpos3, layer);
             }
 
             float f7;
@@ -421,14 +448,14 @@
             {
                 BlockPos blockpos4 = blockpos$pooledmutableblockpos.func_189533_g(blockpos$pooledmutableblockpos2).func_189536_c(blockmodelrenderer$enumneighborinfo.field_178276_g[3]);
                 f7 = p_187491_1_.func_180495_p(blockpos4).func_185892_j();
-                l1 = p_187491_2_.func_185889_a(p_187491_1_, blockpos4);
+                l1 = p_187491_2_.func_177230_c().getPackedLightmapCoords(p_187491_2_, p_187491_1_, blockpos4, layer);
             }
 
-            int i3 = p_187491_2_.func_185889_a(p_187491_1_, p_187491_3_);
+            int i3 = p_187491_2_.func_177230_c().getPackedLightmapCoords(p_187491_2_, p_187491_1_, p_187491_3_, layer);
 
             if (p_187491_6_.get(0) || !p_187491_1_.func_180495_p(p_187491_3_.func_177972_a(p_187491_4_)).func_185914_p())
             {
-                i3 = p_187491_2_.func_185889_a(p_187491_1_, p_187491_3_.func_177972_a(p_187491_4_));
+                i3 = p_187491_2_.func_177230_c().getPackedLightmapCoords(p_187491_2_, p_187491_1_, p_187491_3_.func_177972_a(p_187491_4_), layer);
             }
 
             float f8 = p_187491_6_.get(0) ? p_187491_1_.func_180495_p(blockpos).func_185892_j() : p_187491_1_.func_180495_p(p_187491_3_).func_185892_j();
