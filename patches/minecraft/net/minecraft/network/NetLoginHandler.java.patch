--- ../src_base/minecraft/net/minecraft/network/NetLoginHandler.java
+++ ../src_work/minecraft/net/minecraft/network/NetLoginHandler.java
@@ -10,6 +10,7 @@
 import java.util.Iterator;
 import java.util.List;
 import java.util.Random;
+import java.util.logging.Logger;
 import javax.crypto.SecretKey;
 
 import cpw.mods.fml.common.network.FMLNetworkHandler;
@@ -47,18 +48,26 @@
     private volatile boolean field_72544_i;
 
     /** server ID that is randomly generated by this login handler. */
-    private String loginServerId = "";
+    private String loginServerId = Long.toString(rand.nextLong(), 16); // CraftBukkit - Security fix
     private boolean field_92079_k;
 
     /** Secret AES key obtained from the client's Packet252SharedKey */
     private SecretKey sharedKey;
-
-    public NetLoginHandler(MinecraftServer par1MinecraftServer, Socket par2Socket, String par3Str) throws IOException
+    public String hostname = ""; // CraftBukkit - add field
+
+    public NetLoginHandler(MinecraftServer par1MinecraftServer, Socket par2Socket, String par3Str) throws java.io.IOException   // CraftBukkit - throws IOException
     {
         this.mcServer = par1MinecraftServer;
         this.myTCPConnection = new TcpConnection(par1MinecraftServer.getLogAgent(), par2Socket, par3Str, this, par1MinecraftServer.getKeyPair().getPrivate());
         this.myTCPConnection.field_74468_e = 0;
     }
+
+    // CraftBukkit start
+    public Socket getSocket()
+    {
+        return this.myTCPConnection.getSocket();
+    }
+    // CraftBukkit end
 
     /**
      * Logs the user in if a login packet is found, otherwise keeps processing network packets unless the timeout has
@@ -98,6 +107,9 @@
 
     public void handleClientProtocol(Packet2ClientProtocol par1Packet2ClientProtocol)
     {
+        // CraftBukkit start
+        this.hostname = par1Packet2ClientProtocol.serverHost == null ? "" : par1Packet2ClientProtocol.serverHost + ':' + par1Packet2ClientProtocol.serverPort;
+        // CraftBukkit end
         this.clientUsername = par1Packet2ClientProtocol.getUsername();
 
         if (!this.clientUsername.equals(StringUtils.stripControlCodes(this.clientUsername)))
@@ -146,17 +158,17 @@
     {
         if (par1Packet205ClientCommand.forceRespawn == 0)
         {
-            if (this.field_92079_k)
-            {
-                this.raiseErrorAndDisconnect("Duplicate login");
-                return;
-            }
-
-            this.field_92079_k = true;
+                if (this.field_92079_k)
+                {
+                    this.raiseErrorAndDisconnect("Duplicate login");
+                    return;
+                }
+
+                this.field_92079_k = true;
 
             if (this.mcServer.isServerInOnlineMode())
             {
-                (new ThreadLoginVerifier(this)).start();
+                (new ThreadLoginVerifier(this, mcServer.server)).start(); // CraftBukkit - add CraftServer
             }
             else
             {
@@ -180,18 +192,26 @@
 
     public void completeConnection(String s)
     {
-
         if (s != null)
         {
             this.raiseErrorAndDisconnect(s);
         }
+
+        // CraftBukkit start
+        EntityPlayerMP entityplayermp = this.mcServer.getConfigurationManager().attemptLogin(this, this.clientUsername, this.hostname);
+
+        if (entityplayermp == null)
+        {
+            return;
+            // CraftBukkit end
+        }
         else
         {
-            EntityPlayerMP entityplayermp = this.mcServer.getConfigurationManager().createPlayerForUser(this.clientUsername);
+            entityplayermp = this.mcServer.getConfigurationManager().processLogin(entityplayermp); // CraftBukkit - this.h -> s // MCPC+ - reuse variable
 
             if (entityplayermp != null)
             {
-                this.mcServer.getConfigurationManager().initializeConnectionToPlayer(this.myTCPConnection, entityplayermp);
+                this.mcServer.getConfigurationManager().initializeConnectionToPlayer((INetworkManager) this.myTCPConnection, entityplayermp);
             }
         }
 
@@ -209,40 +229,52 @@
      */
     public void handleServerPing(Packet254ServerPing par1Packet254ServerPing)
     {
+        if (this.getSocket() == null) // MCPC+ - remove myTCPConnection
+        {
+            return;    // CraftBukkit - fix NPE when a client queries a server that is unable to handle it.
+        }
+
         try
         {
             ServerConfigurationManager serverconfigurationmanager = this.mcServer.getConfigurationManager();
             String s = null;
+            // CraftBukkit
+            org.bukkit.event.server.ServerListPingEvent pingEvent = org.bukkit.craftbukkit.event.CraftEventFactory.callServerListPingEvent(this.mcServer.server, getSocket().getInetAddress(), this.mcServer.getMOTD(), serverconfigurationmanager.getCurrentPlayerCount(), serverconfigurationmanager.getMaxPlayers());
 
             if (par1Packet254ServerPing.func_140050_d())
             {
-                s = this.mcServer.getMOTD() + "\u00a7" + serverconfigurationmanager.getCurrentPlayerCount() + "\u00a7" + serverconfigurationmanager.getMaxPlayers();
+                // CraftBukkit
+                s = pingEvent.getMotd() + "\u00A7" + serverconfigurationmanager.getCurrentPlayerCount() + "\u00A7" + pingEvent.getMaxPlayers();
             }
             else
             {
-                List list = Arrays.asList(new Serializable[] {Integer.valueOf(1), Integer.valueOf(73), this.mcServer.getMinecraftVersion(), this.mcServer.getMOTD(), Integer.valueOf(serverconfigurationmanager.getCurrentPlayerCount()), Integer.valueOf(serverconfigurationmanager.getMaxPlayers())});
-                Object object;
-
-                for (Iterator iterator = list.iterator(); iterator.hasNext(); s = s + object.toString().replaceAll("\u0000", ""))
+                // CraftBukkit start - Don't create a list from an array
+                Object[] list = new Object[] { 1, 73, this.mcServer.getMinecraftVersion(), pingEvent.getMotd(), serverconfigurationmanager.getCurrentPlayerCount(), pingEvent.getMaxPlayers() };
+                StringBuilder builder = new StringBuilder();
+
+                for (Object object : list)
                 {
-                    object = iterator.next();
-
-                    if (s == null)
+                    if (builder.length() == 0)
                     {
-                        s = "\u00a7";
+                        builder.append('\u00A7');
                     }
                     else
                     {
-                        s = s + "\u0000";
+                        builder.append('\0');
                     }
+
+                    builder.append(org.apache.commons.lang.StringUtils.replace(object.toString(), "\0", ""));
                 }
+
+                s = builder.toString();
+                // CraftBukkit end
             }
 
             InetAddress inetaddress = null;
 
-            if (this.myTCPConnection.getSocket() != null)
-            {
-                inetaddress = this.myTCPConnection.getSocket().getInetAddress();
+            if (this.getSocket() != null) // MCPC+ - remove myTCPConnection
+            {
+                inetaddress = this.getSocket().getInetAddress(); // MCPC+ - remove myTCPConnection
             }
 
             this.myTCPConnection.addToSendQueue(new Packet255KickDisconnect(s));
@@ -320,11 +352,24 @@
         return par0NetLoginHandler.field_72544_i = par1;
     }
     
-
+    // Spigot start
+    @Override
     public void handleCustomPayload(Packet250CustomPayload par1Packet250CustomPayload)
     {
-        FMLNetworkHandler.handlePacket250Packet(par1Packet250CustomPayload, myTCPConnection, this);
-    }
+        if (par1Packet250CustomPayload.channel.equals("BungeeCord") && org.bukkit.craftbukkit.Spigot.bungeeIPs.contains(getSocket().getInetAddress().getHostAddress()))
+        {
+            com.google.common.io.ByteArrayDataInput in = com.google.common.io.ByteStreams.newDataInput(par1Packet250CustomPayload.data);
+            String subTag = in.readUTF();
+
+            if (subTag.equals("Login"))
+            {
+                myTCPConnection.setSocketAddress(new java.net.InetSocketAddress(in.readUTF(), in.readInt()));
+            }
+        }
+            
+        FMLNetworkHandler.handlePacket250Packet(par1Packet250CustomPayload, myTCPConnection, this);  // MCPC+
+    }
+    // Spigot end    
 
     @Override
     public void handleVanilla250Packet(Packet250CustomPayload payload)
