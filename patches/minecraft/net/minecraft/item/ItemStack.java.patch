--- ../src_base/minecraft/net/minecraft/item/ItemStack.java
+++ ../src_work/minecraft/net/minecraft/item/ItemStack.java
@@ -20,6 +20,7 @@
 import net.minecraft.entity.ai.attributes.AttributeModifier;
 import net.minecraft.entity.item.EntityItemFrame;
 import net.minecraft.entity.player.EntityPlayer;
+import net.minecraft.entity.player.EntityPlayerMP;
 import net.minecraft.nbt.NBTBase;
 import net.minecraft.nbt.NBTTagCompound;
 import net.minecraft.nbt.NBTTagList;
@@ -128,6 +129,7 @@
      */
     public Item getItem()
     {
+        if (this.itemID < 0) return null; // MCPC+
         return Item.itemsList[this.itemID];
     }
 
@@ -192,7 +194,7 @@
 
         if (this.stackTagCompound != null)
         {
-            par1NBTTagCompound.setTag("tag", this.stackTagCompound);
+            par1NBTTagCompound.setTag("tag", this.stackTagCompound.copy()); // CraftBukkit - make defensive copy, data is going to another thread
         }
 
         return par1NBTTagCompound;
@@ -214,7 +216,8 @@
 
         if (par1NBTTagCompound.hasKey("tag"))
         {
-            this.stackTagCompound = par1NBTTagCompound.getCompoundTag("tag");
+            // CraftBukkit - make defensive copy as this data may be coming from the save thread
+            this.stackTagCompound = (NBTTagCompound) par1NBTTagCompound.getCompoundTag("tag").copy();
         }
     }
 
@@ -252,7 +255,9 @@
      */
     public boolean isItemDamaged()
     {
-        return this.isItemStackDamageable() && this.itemDamage > 0;
+        boolean damaged = itemDamage > 0;
+        if (getItem() != null) damaged = getItem().isDamaged(this);
+        return this.isItemStackDamageable() && damaged;
     }
 
     /**
@@ -260,6 +265,10 @@
      */
     public int getItemDamageForDisplay()
     {
+        if (getItem() != null)
+        {
+            return getItem().getDisplayDamage(this);
+        }
         return this.itemDamage;
     }
 
@@ -268,6 +277,10 @@
      */
     public int getItemDamage()
     {
+        if (getItem() != null)
+        {
+            return getItem().getDamage(this);
+        }
         return this.itemDamage;
     }
 
@@ -276,6 +289,12 @@
      */
     public void setItemDamage(int par1)
     {
+        if (getItem() != null)
+        {
+            getItem().setDamage(this, par1);
+            return;
+        }
+
         this.itemDamage = par1;
 
         if (this.itemDamage < 0)
@@ -289,7 +308,7 @@
      */
     public int getMaxDamage()
     {
-        return Item.itemsList[this.itemID].getMaxDamage();
+        return this.getItem().getMaxDamage(this);
     }
 
     /**
@@ -298,8 +317,15 @@
      * getMaxDamage(). Returns false otherwise or if the ItemStack can't be damaged or if all points of damage are
      * negated.
      */
+    // Spigot start
     public boolean attemptDamageItem(int par1, Random par2Random)
     {
+        return isDamaged(par1, par2Random, null);
+    }
+
+    public boolean isDamaged(int par1, Random par2Random, EntityLivingBase entitylivingbase)
+    {
+        // Spigot end
         if (!this.isItemStackDamageable())
         {
             return false;
@@ -321,14 +347,29 @@
 
                 par1 -= k;
 
+                // Spigot start
+                if (entitylivingbase instanceof EntityPlayerMP)
+                {
+                    org.bukkit.craftbukkit.inventory.CraftItemStack item = org.bukkit.craftbukkit.inventory.CraftItemStack.asCraftMirror(this);
+                    org.bukkit.event.player.PlayerItemDamageEvent event = new org.bukkit.event.player.PlayerItemDamageEvent((org.bukkit.entity.Player) entitylivingbase.getBukkitEntity(), item, par1);
+                    org.bukkit.Bukkit.getServer().getPluginManager().callEvent(event);
+
+                    if (event.isCancelled())
+                    {
+                        return false;
+                    }
+
+                    par1 = event.getDamage();
+                }
+
                 if (par1 <= 0)
                 {
                     return false;
                 }
             }
 
-            this.itemDamage += par1;
-            return this.itemDamage > this.getMaxDamage();
+            setItemDamage(getItemDamage() + par1); //Redirect through Item's callback if applicable.
+            return getItemDamage() > getMaxDamage();
         }
     }
 
@@ -362,6 +403,13 @@
                         this.stackSize = 0;
                     }
 
+                    // CraftBukkit start - Check for item breaking
+                    if (this.stackSize == 0 && par2EntityLivingBase instanceof EntityPlayer)
+                    {
+                        org.bukkit.craftbukkit.event.CraftEventFactory.callPlayerItemBreakEvent((EntityPlayer) par2EntityLivingBase, this);
+                    }
+
+                    // CraftBukkit end
                     this.itemDamage = 0;
                 }
             }
@@ -396,7 +444,7 @@
      */
     public boolean canHarvestBlock(Block par1Block)
     {
-        return Item.itemsList[this.itemID].canHarvestBlock(par1Block);
+        return Item.itemsList[this.itemID].canHarvestBlock(par1Block, this);
     }
 
     public boolean func_111282_a(EntityPlayer par1EntityPlayer, EntityLivingBase par2EntityLivingBase)
@@ -478,7 +526,15 @@
             --this.animationsToGo;
         }
 
-        Item.itemsList[this.itemID].onUpdate(this, par1World, par2Entity, par3, par4);
+        // MCPC+ start - print exception instead of kicking client (if they have a corrupted item in their inventory)
+        try {
+            Item.itemsList[this.itemID].onUpdate(this, par1World, par2Entity, par3, par4);
+        } catch (Throwable ex) {
+            System.out.println("updateAnimation exception");
+            ex.printStackTrace();
+            return;
+        }
+        // MCPC+ end
     }
 
     public void onCrafting(World par1World, EntityPlayer par2EntityPlayer, int par3)
@@ -531,6 +587,13 @@
      */
     public void setTagCompound(NBTTagCompound par1NBTTagCompound)
     {
+        // CraftBukkit start - Set compound name to "tag," remove discrepancy
+        if (par1NBTTagCompound != null)
+        {
+            par1NBTTagCompound.setName("tag");
+        }
+
+        // CraftBukkit end
         this.stackTagCompound = par1NBTTagCompound;
     }
 
@@ -737,10 +800,16 @@
         return arraylist;
     }
 
+    @Deprecated
     @SideOnly(Side.CLIENT)
     public boolean hasEffect()
     {
-        return this.getItem().hasEffect(this);
+        return hasEffect(0);
+    }
+    @SideOnly(Side.CLIENT)
+    public boolean hasEffect(int pass)
+    {
+        return this.getItem().hasEffect(this, pass);
     }
 
     @SideOnly(Side.CLIENT)
