--- ../src_base/minecraft/net/minecraft/block/BlockMushroom.java
+++ ../src_work/minecraft/net/minecraft/block/BlockMushroom.java
@@ -3,6 +3,17 @@
 import java.util.Random;
 import net.minecraft.world.World;
 import net.minecraft.world.gen.feature.WorldGenBigMushroom;
+
+import net.minecraftforge.common.ForgeDirection;
+// CraftBukkit start
+import java.util.ArrayList;
+import net.minecraft.item.ItemStack;
+import org.bukkit.Location;
+import org.bukkit.TreeType;
+import org.bukkit.block.BlockState;
+import org.bukkit.event.block.BlockSpreadEvent;
+import org.bukkit.event.world.StructureGrowEvent;
+// CraftBukkit end
 
 public class BlockMushroom extends BlockFlower
 {
@@ -19,7 +30,9 @@
      */
     public void updateTick(World par1World, int par2, int par3, int par4, Random par5Random)
     {
-        if (par5Random.nextInt(25) == 0)
+        final int sourceX = par2, sourceY = par3, sourceZ = par4; // CraftBukkit
+
+        if (par5Random.nextInt(Math.max(1, (int) par1World.growthOdds / par1World.spigotConfig.mushroomModifier * 25)) == 0) // Spigot
         {
             byte b0 = 4;
             int l = 5;
@@ -66,7 +79,18 @@
 
             if (par1World.isAirBlock(i1, j1, k1) && this.canBlockStay(par1World, i1, j1, k1))
             {
-                par1World.setBlock(i1, j1, k1, this.blockID, 0, 2);
+                // CraftBukkit start
+                org.bukkit.World bworld = par1World.getWorld();
+                BlockState blockState = bworld.getBlockAt(i1, j1, k1).getState();
+                blockState.setTypeId(this.blockID);
+                BlockSpreadEvent event = new BlockSpreadEvent(blockState.getBlock(), bworld.getBlockAt(sourceX, sourceY, sourceZ), blockState);
+                par1World.getServer().getPluginManager().callEvent(event);
+
+                if (!event.isCancelled())
+                {
+                    blockState.update(true);
+                }
+                // CraftBukkit end
             }
         }
     }
@@ -96,40 +120,91 @@
         if (par3 >= 0 && par3 < 256)
         {
             int l = par1World.getBlockId(par2, par3 - 1, par4);
-            return l == Block.mycelium.blockID || par1World.getFullBlockLightValue(par2, par3, par4) < 13 && this.canThisPlantGrowOnThisBlockID(l);
+            Block soil = Block.blocksList[l];
+            return (l == Block.mycelium.blockID || par1World.getFullBlockLightValue(par2, par3, par4) < 13) &&
+                   (soil != null && soil.canSustainPlant(par1World, par2, par3 - 1, par4, ForgeDirection.UP, this));
         }
         else
         {
             return false;
         }
     }
-
+    
+    // MCPC+ start - wrapper for vanilla compatibility
+    public boolean fertilizeMushroom(World world, int i, int j, int k, Random random)
+    {
+        return this.fertilizeMushroom(world, i, j, k, random, false, null, null);
+    }
+    // MCPC+ end    
+
+    // CraftBukkit - added bonemeal, player and itemstack
     /**
      * Fertilize the mushroom.
      */
-    public boolean fertilizeMushroom(World par1World, int par2, int par3, int par4, Random par5Random)
+    public boolean fertilizeMushroom(World par1World, int par2, int par3, int par4, Random par5Random, boolean bonemeal, org.bukkit.entity.Player player, ItemStack itemstack)
     {
         int l = par1World.getBlockMetadata(par2, par3, par4);
         par1World.setBlockToAir(par2, par3, par4);
+        // CraftBukkit start
+        boolean grown = false;
+        StructureGrowEvent event = null;
+        Location location = new Location(par1World.getWorld(), par2, par3, par4);
         WorldGenBigMushroom worldgenbigmushroom = null;
 
-        if (this.blockID == Block.mushroomBrown.blockID)
-        {
-            worldgenbigmushroom = new WorldGenBigMushroom(0);
-        }
-        else if (this.blockID == Block.mushroomRed.blockID)
-        {
-            worldgenbigmushroom = new WorldGenBigMushroom(1);
-        }
-
-        if (worldgenbigmushroom != null && worldgenbigmushroom.generate(par1World, par5Random, par2, par3, par4))
-        {
-            return true;
-        }
-        else
-        {
-            par1World.setBlock(par2, par3, par4, this.blockID, l, 3);
-            return false;
-        }
+        // MCPC+ start - add support for Twilight Forest; CB only if non-null player, otherwise vanilla
+        if (player != null)
+        {
+            if (this.blockID == Block.mushroomBrown.blockID)
+            {
+                event = new StructureGrowEvent(location, TreeType.BROWN_MUSHROOM, bonemeal, player, new ArrayList<BlockState>());
+                worldgenbigmushroom = new WorldGenBigMushroom(0);
+            }
+            else if (this.blockID == Block.mushroomRed.blockID)
+            {
+                event = new StructureGrowEvent(location, TreeType.RED_MUSHROOM, bonemeal, player, new ArrayList<BlockState>());
+                worldgenbigmushroom = new WorldGenBigMushroom(1);
+            }
+
+            if (worldgenbigmushroom != null && event != null)
+            {
+                grown = worldgenbigmushroom.grow((org.bukkit.BlockChangeDelegate)par1World, par5Random, par2, par3, par4, event, itemstack, par1World.getWorld());
+
+                if (event.isFromBonemeal() && itemstack != null)
+                {
+                    --itemstack.stackSize;
+                }
+            }
+
+            if (!grown || event.isCancelled())
+            {
+                par1World.setBlock(par2, par3, par4, this.blockID, l, 4);
+                return false;
+            }
+        }
+        else 
+        { // do vanilla
+            if (this.blockID == Block.mushroomBrown.blockID)
+            {
+                worldgenbigmushroom = new WorldGenBigMushroom(0);
+            }
+            else if (this.blockID == Block.mushroomRed.blockID)
+            {
+                worldgenbigmushroom = new WorldGenBigMushroom(1);
+            }
+
+            if (worldgenbigmushroom != null && worldgenbigmushroom.generate(par1World, par5Random, par2, par3, par4))
+            {
+                return true;
+            }
+            else
+            {
+                par1World.setBlock(par2, par3, par4, this.blockID, l, 3);
+                return false;
+            }
+        }
+        // MCPC+ end        
+
+        return true;
+        // CraftBukkit end
     }
 }
